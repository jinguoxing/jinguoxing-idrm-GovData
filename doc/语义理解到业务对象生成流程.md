# 语义理解到业务对象生成流程优化方案

## 一、当前流程分析

### 现状
1. 用户在逻辑视图完成AI语义分析
2. 点击"生成业务对象"按钮
3. 简单alert提示后跳转到业务对象建模页面
4. 需要手动创建业务对象

### 问题
- ❌ 缺少预览和确认环节
- ❌ 用户不知道会生成什么内容
- ❌ 无法在生成前进行调整
- ❌ 生成后需要手动定位
- ❌ 流程中断，体验不连贯

---

## 二、优化后的流程设计

### 流程概览
```
语义理解完成
    ↓
点击"生成业务对象"
    ↓
【预览生成向导】
    ├─ 步骤1：基本信息确认
    │   ├─ 业务对象名称（可编辑）
    │   ├─ 业务对象编码（自动生成，可编辑）
    │   └─ 业务描述（自动填充，可编辑）
    ├─ 步骤2：字段映射预览
    │   ├─ 物理字段 → 业务属性映射表
    │   ├─ 语义角色自动标注
    │   ├─ 字段类型自动转换
    │   └─ 支持调整和删除字段
    ├─ 步骤3：生成选项
    │   ├─ 是否立即发布
    │   ├─ 是否创建映射关系
    │   └─ 是否发送通知
    ↓
用户确认生成
    ↓
【生成中动画】
    ├─ 创建业务对象
    ├─ 创建字段映射
    ├─ 建立数据血缘
    └─ 记录操作日志
    ↓
【生成成功】
    ├─ 显示生成结果摘要
    ├─ 自动跳转到业务对象建模页
    ├─ 自动定位到新创建的业务对象
    └─ 高亮显示新对象
```

---

## 三、详细功能设计

### 3.1 预览生成向导（模态框）

#### 布局结构
```
┌─────────────────────────────────────────────┐
│  从语义理解生成业务对象                     │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  [步骤1] [步骤2] [步骤3]                    │
│                                             │
│  ┌───────────────────────────────────────┐ │
│  │  步骤1：基本信息                      │ │
│  │                                       │ │
│  │  业务对象名称: [订单        ] ✏️     │ │
│  │  业务对象编码: [biz_order   ] ✏️     │ │
│  │  业务描述:     [多行文本...] ✏️     │ │
│  │  来源表:       order_info (只读)     │ │
│  └───────────────────────────────────────┘ │
│                                             │
│  [上一步]              [下一步] →          │
└─────────────────────────────────────────────┘
```

#### 步骤1：基本信息确认
**数据来源**：
- 业务对象名称：从 `semanticProfile.businessName` 获取，去除后缀"（业务视图）"
- 业务对象编码：自动生成 `biz_${tableName.replace('t_', '')}`，可编辑
- 业务描述：从 `semanticProfile.description` 获取，可编辑
- 来源表：只读显示物理表名

**交互**：
- 名称和编码实时验证（不能为空，编码需唯一）
- 编码建议提示（基于表名生成建议）
- 描述支持多行编辑

#### 步骤2：字段映射预览
**布局**：
```
┌─────────────────────────────────────────────┐
│  字段映射 (8个字段)                         │
│                                             │
│  [✓] 字段名     语义角色  属性名  类型  操作│
│  [✓] order_id   标识      id      String  [删除]│
│  [✓] user_id    关联      userId  String  [删除]│
│  [✓] amount     属性      amount  Decimal [删除]│
│  [✗] create_time 时间戳   (跳过)           │
│                                             │
│  已选择: 3 个字段                           │
└─────────────────────────────────────────────┘
```

**字段映射规则**：
1. **自动映射**：
   - 物理字段名 → 业务属性名（驼峰命名转换）
   - 字段类型 → 业务类型（自动转换）
   - 语义角色 → 属性分类（标识、属性、关联、状态等）

2. **字段过滤**：
   - 默认包含所有非时间戳字段
   - 标识字段（PK）自动包含
   - 时间戳字段（create_time, update_time）默认跳过
   - 用户可手动调整

3. **属性命名建议**：
   - `order_id` → `id` (如果是主键)
   - `user_id` → `userId` (外键)
   - `order_amount` → `amount` (去除表名前缀)
   - `create_time` → `createdAt` (时间戳转换)

**交互**：
- 复选框控制字段是否包含
- 点击字段行可编辑属性名和类型
- 删除按钮移除字段
- 显示映射预览（物理字段 → 业务属性）

#### 步骤3：生成选项
**选项**：
```
□ 立即发布业务对象
  （生成后状态为"已发布"，否则为"草稿"）

□ 创建物理表到业务对象的映射关系
  （在映射工作台中自动创建映射记录）

□ 发送通知给相关人员
  （通知业务负责人新业务对象已创建）

生成位置：
  [选择业务域 ▼] 可选，留空则在默认域
```

---

### 3.2 生成过程反馈

#### 生成中状态
```
┌─────────────────────────────────────────────┐
│  正在生成业务对象...                        │
│                                             │
│  ┌───────────────────────────────────────┐ │
│  │  ● 创建业务对象定义                    │ │
│  │  ● 创建业务属性                        │ │
│  │  ⏳ 建立字段映射关系                   │ │
│  │  ⏸  创建数据血缘                      │ │
│  │  ⏸  记录操作日志                      │ │
│  └───────────────────────────────────────┘ │
│                                             │
│  预计剩余时间: 2秒                          │
└─────────────────────────────────────────────┘
```

**步骤指示**：
1. ✅ 创建业务对象定义
2. ✅ 创建业务属性
3. ⏳ 建立字段映射关系（当前）
4. ⏸ 创建数据血缘
5. ⏸ 记录操作日志

---

### 3.3 生成成功反馈

#### 成功提示
```
┌─────────────────────────────────────────────┐
│  ✓ 业务对象生成成功！                       │
│                                             │
│  已创建:                                    │
│  • 业务对象: 订单 (BO_20240521_001)        │
│  • 业务属性: 8 个                           │
│  • 字段映射: 8 条                           │
│  • 数据血缘: 已建立                         │
│                                             │
│  [查看详情]  [继续编辑]  [关闭]             │
└─────────────────────────────────────────────┘
```

**操作选项**：
- **查看详情**：跳转到业务对象建模页，显示新对象详情
- **继续编辑**：跳转到业务对象建模页，进入编辑模式
- **关闭**：关闭弹窗，留在当前页面

---

### 3.4 跳转后的交互

#### 业务对象建模页增强
1. **自动定位**：
   - 跳转后自动选中新创建的业务对象
   - 左侧列表高亮显示
   - 右侧详情面板自动展开

2. **高亮提示**：
   - 新创建的对象有"新创建"徽章
   - 3秒后自动消失
   - 可以使用关闭按钮手动关闭

3. **引导提示**：
   - 第一次生成时显示引导提示
   - "你可以在左侧列表编辑业务对象"
   - 提供快捷操作按钮

---

## 四、用户体验优化

### 4.1 预览和确认
✅ **所见即所得**：用户在生成前就能看到完整的业务对象结构
✅ **可调整**：可以在生成前修改任何内容
✅ **减少错误**：提前发现并修正问题

### 4.2 流程连贯性
✅ **无缝跳转**：生成后自动定位到新对象
✅ **状态保持**：保留用户的编辑状态
✅ **操作反馈**：清晰的进度和结果提示

### 4.3 智能建议
✅ **自动命名**：基于语义理解结果自动生成合理的名称和编码
✅ **字段过滤**：智能识别并跳过技术字段（如时间戳）
✅ **类型转换**：自动转换物理类型到业务类型

### 4.4 容错处理
✅ **验证机制**：生成前验证必填项和唯一性
✅ **错误提示**：友好的错误提示和解决建议
✅ **撤销机制**：支持撤销生成操作（在一定时间内）

---

## 五、技术实现要点

### 5.1 数据转换逻辑

```typescript
// 从语义理解结果生成业务对象
function generateBusinessObject(semanticProfile, table) {
  return {
    name: semanticProfile.businessName.replace(/（业务视图）/, ''),
    code: generateCode(table.name),
    description: semanticProfile.description,
    fields: semanticProfile.fieldSemantics
      .filter(fs => shouldIncludeField(fs))
      .map(fs => convertToBusinessField(fs))
  };
}

// 字段过滤规则
function shouldIncludeField(fieldSemantic) {
  // 跳过技术字段
  if (fieldSemantic.semanticRole === '时间戳') {
    const fieldName = fieldSemantic.field.toLowerCase();
    if (fieldName.includes('create') || fieldName.includes('update')) {
      return false; // 跳过创建/更新时间
    }
  }
  return true;
}

// 字段类型转换
function convertToBusinessField(fieldSemantic) {
  return {
    name: convertToCamelCase(fieldSemantic.field),
    code: generateFieldCode(fieldSemantic.field),
    type: convertPhysicalTypeToBusinessType(fieldSemantic.physicalType),
    semanticRole: fieldSemantic.semanticRole,
    description: fieldSemantic.reason || ''
  };
}
```

### 5.2 向导组件结构

```typescript
interface GenerationWizardProps {
  table: Table;
  semanticProfile: SemanticProfile;
  onConfirm: (config: GenerationConfig) => void;
  onCancel: () => void;
}

interface GenerationConfig {
  // 步骤1
  name: string;
  code: string;
  description: string;
  
  // 步骤2
  fields: FieldMapping[];
  
  // 步骤3
  options: {
    publishImmediately: boolean;
    createMapping: boolean;
    sendNotification: boolean;
    domain?: string;
  };
}
```

### 5.3 状态管理

```typescript
const [wizardStep, setWizardStep] = useState(1);
const [generationConfig, setGenerationConfig] = useState({
  name: '',
  code: '',
  description: '',
  fields: [],
  options: {}
});
const [isGenerating, setIsGenerating] = useState(false);
const [generatedBOId, setGeneratedBOId] = useState(null);
```

---

## 六、流程图（用户视角）

```
用户操作流程：
┌─────────────────────────────────────────┐
│ 1. 在逻辑视图完成AI语义分析             │
│    ↓                                    │
│ 2. 查看语义理解结果                     │
│    ├─ 业务名称：订单（业务视图）        │
│    ├─ 业务描述：...                    │
│    ├─ 核心字段：order_id, user_id...   │
│    └─ 字段语义：标识、关联、属性...    │
│    ↓                                    │
│ 3. 点击"生成业务对象"按钮               │
│    ↓                                    │
│ 4. 打开生成向导                         │
│    ├─ 步骤1：确认基本信息               │
│    │   - 名称：订单 ✓                  │
│    │   - 编码：biz_order ✓             │
│    │   - 描述：... ✓                   │
│    │   [下一步 →]                      │
│    ↓                                    │
│    ├─ 步骤2：确认字段映射               │
│    │   - 已选择 8 个字段                │
│    │   - 字段映射预览                  │
│    │   - 可调整和删除                  │
│    │   [← 上一步] [下一步 →]           │
│    ↓                                    │
│    ├─ 步骤3：设置生成选项               │
│    │   - ☑ 立即发布                    │
│    │   - ☑ 创建映射关系                │
│    │   - ☐ 发送通知                    │
│    │   [← 上一步] [确认生成]           │
│    ↓                                    │
│ 5. 显示生成进度                         │
│    - 创建业务对象定义 ✓                 │
│    - 创建业务属性 ✓                     │
│    - 建立字段映射关系 ⏳                │
│    ↓                                    │
│ 6. 生成成功提示                         │
│    - 已创建业务对象：订单               │
│    - 已创建业务属性：8 个               │
│    [查看详情] [继续编辑]                │
│    ↓                                    │
│ 7. 自动跳转到业务对象建模页             │
│    - 左侧列表自动选中"订单"             │
│    - 右侧显示业务对象详情               │
│    - 高亮显示"新创建"徽章               │
└─────────────────────────────────────────┘
```

---

## 七、关键优化点总结

### 7.1 用户体验
1. **预览机制**：生成前完整预览，减少错误
2. **智能建议**：自动生成合理的默认值
3. **可调整性**：所有内容都可以在生成前编辑
4. **流程连贯**：无缝跳转，自动定位

### 7.2 交互设计
1. **分步向导**：清晰的步骤指引
2. **实时验证**：即时反馈输入错误
3. **进度反馈**：清晰的生成进度
4. **结果确认**：明确的成功提示

### 7.3 功能完整性
1. **数据映射**：自动建立字段映射关系
2. **数据血缘**：自动创建血缘链路
3. **操作日志**：记录完整的操作历史
4. **通知机制**：可选的通知功能

---

## 八、后续扩展

1. **批量生成**：支持从多个语义理解结果批量生成业务对象
2. **模板机制**：支持保存和复用生成配置模板
3. **差异对比**：生成前对比现有业务对象，提示冲突
4. **版本管理**：支持生成新版本业务对象
5. **回滚机制**：支持撤销生成操作


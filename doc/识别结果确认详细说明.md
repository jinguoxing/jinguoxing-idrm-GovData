# 识别结果确认 - 详细逻辑与规则说明

## 一、功能定位

**识别结果确认**是 Bottom-up 识别模块的核心确认环节，用于验证和确认 AI + 规则引擎对数据表的语义识别结果。

### 核心目标
- **验证准确性**：让业务人员判断识别结果是否符合业务认知
- **提升效率**：支持批量处理高置信度识别结果
- **解决冲突**：处理规则引擎与 AI 判断不一致的情况
- **建立信任**：通过透明化规则和 AI 判断过程，建立用户信任

---

## 二、整体数据流

```
输入数据
  ↓
[识别结果确认模块]
  ├─ 识别任务概览 → 统计展示
  ├─ 识别结果对比 → 逐项确认
  ├─ 批量确认 → 批量处理
  └─ 冲突解释 → 冲突解决
  ↓
输出数据（已确认的识别结果）
```

---

## 三、输入数据格式

### 3.1 主要输入：识别结果数据（identificationResults）

```typescript
interface IdentificationResult {
  // 表基本信息
  id: string;                    // 唯一标识，如 'IR_001'
  tableName: string;             // 表名，如 'order_info'
  tableComment: string;          // 表注释，如 '订单表'
  sourceId: string;              // 数据源ID，如 'DS_001'
  
  // 表级对象建议
  objectSuggestion: {
    name: string;                // 建议的对象名称，如 '订单'
    confidence: number;          // 置信度 [0-1]，如 0.92
    risk: 'low' | 'medium' | 'high';  // 风险等级
    status: 'pending' | 'accepted' | 'rejected';  // 确认状态
    source: string;              // 来源，如 'AI + 规则' 或 'AI'
    auditTrail?: {               // 可回溯信息（确认后生成）
      recordBy: string;          // 记录人
      recordTime: string;        // 记录时间
      action: 'accept' | 'reject';
      basis: 'rule' | 'ai' | 'manual' | 'batch';
      source?: string;
    };
  };
  
  // 字段级语义分类
  fieldSuggestions: Array<{
    field: string;               // 字段名，如 'order_id'
    semanticRole: string;        // 语义角色，如 '标识'、'状态'、'行为线索'
    aiExplanation: string;       // AI 解释，如 '主键'
    confidence: number;          // 置信度 [0-1]
    status: 'pending' | 'accepted' | 'rejected' | 'warning';
    conflict?: boolean;          // 是否存在冲突
    auditTrail?: {               // 可回溯信息
      recordBy: string;
      recordTime: string;
      action: 'accept' | 'reject';
      basis: 'rule' | 'ai' | 'manual' | 'batch';
      originalAI?: string;       // 原始 AI 判断
      originalRule?: string;     // 原始规则判断
      decision?: 'rule' | 'ai' | 'manual';
      note?: string;             // 决策说明
    };
  }>;
  
  // 状态/行为升级建议
  upgradeSuggestions: Array<{
    type: '状态' | '行为' | '事件';  // 升级类型
    source: string;              // 源字段名
    target: string;              // 目标对象/行为名称
    confidence: number;          // 置信度
  }>;
  
  // 状态标识
  needsConfirmation: boolean;    // 是否需要确认
  hasConflict: boolean;          // 是否存在冲突
}
```

### 3.2 辅助输入

- **数据源信息（dataSources）**：用于显示表所属的数据源
- **扫描资产（scanAssets）**：物理表的扫描结果（可选）

---

## 四、输出数据格式

### 4.1 确认后的识别结果

输出格式与输入格式相同，但包含以下变化：

1. **状态更新**：
   - `objectSuggestion.status`: 从 `pending` 变为 `accepted` 或 `rejected`
   - `fieldSuggestions[].status`: 从 `pending`/`warning` 变为 `accepted` 或 `rejected`
   - `needsConfirmation`: 从 `true` 变为 `false`（确认后）

2. **冲突解决**：
   - `hasConflict`: 从 `true` 变为 `false`（解决所有冲突后）
   - `fieldSuggestions[].conflict`: 从 `true` 变为 `false`

3. **可回溯信息（auditTrail）**：每次确认操作都会生成
   - 表级确认：记录对象级别的确认信息
   - 字段级确认：记录字段级别的确认信息，包含决策依据

4. **语义角色更新**（冲突解释页决策后）：
   - `fieldSuggestions[].semanticRole`: 可能从 AI 判断改为规则判断或手动指定

---

## 五、详细逻辑规则

### 5.1 识别任务概览页逻辑

#### 5.1.1 统计计算规则

```typescript
统计指标计算：
- 总表数 = identificationResults.length
- 已接受数 = results.filter(r => r.objectSuggestion.status === 'accepted').length
- 待确认数 = results.filter(r => r.needsConfirmation).length
- 冲突项数 = results.filter(r => r.hasConflict).length
- 平均置信度 = sum(r.objectSuggestion.confidence) / results.length
```

#### 5.1.2 快速操作逻辑
- 点击按钮跳转到对应标签页
- 保持数据状态一致

---

### 5.2 识别结果对比页逻辑

#### 5.2.1 筛选规则

```typescript
筛选条件（可组合）：
1. 仅显示需确认：
   - 条件：r.needsConfirmation === true
   - 作用：只显示需要人工确认的表

2. 仅显示冲突：
   - 条件：r.hasConflict === true
   - 作用：只显示存在冲突的表

3. 按置信度排序：
   - 降序排列：高置信度在前
   - 排序键：objectSuggestion.confidence
```

#### 5.2.2 排序规则

- **按置信度排序**（默认）：
  ```
  排序键：objectSuggestion.confidence
  排序方式：降序（高→低）
  ```

- **按表名排序**：
  ```
  排序键：tableName
  排序方式：升序（字典序）
  ```

#### 5.2.3 字段高亮逻辑

```typescript
高亮触发：
1. 用户点击左侧字段标签
2. 设置 highlightedField = fieldName
3. 右侧表格对应字段行高亮显示（背景色 + 边框 + 字体加粗）

高亮取消：
1. 切换到其他字段时自动取消
2. 切换到其他表时自动取消
```

#### 5.2.4 确认操作逻辑

**表级确认**：
```typescript
操作：accept / reject / edit
逻辑：
1. 更新 objectSuggestion.status
2. 如果 accept：needsConfirmation = false
3. 生成 auditTrail：
   - recordBy: 当前用户
   - recordTime: 当前时间戳
   - action: 'accept' | 'reject'
   - basis: 根据 source 判断（'rule' | 'ai' | 'manual'）
   - source: 原始来源
```

**字段级确认**：
```typescript
操作：accept
逻辑：
1. 更新对应字段的 status = 'accepted'
2. 生成 auditTrail（同表级，但包含字段信息）
3. 如果该字段有冲突，conflict = false
4. 检查表是否还有其他冲突，更新 hasConflict
```

#### 5.2.5 AI 解释展开逻辑

```typescript
展开触发：
1. 点击字段行的"为什么"按钮
2. 切换 showWhyExplanation[tableId_field] 状态

展示内容：
- AI 推理依据
- 命名模式分析
- 业务语义分析
- 数据特征说明
```

---

### 5.3 批量确认页逻辑

#### 5.3.1 筛选规则

```typescript
筛选条件（可组合）：
1. 类型筛选：
   - 'all': 全部
   - 'table': 仅表对象
   - 'field': 仅字段

2. 置信度筛选：
   - 'high': confidence >= 0.8
   - 'medium': 0.6 <= confidence < 0.8
   - 'low': confidence < 0.6

3. 仅显示需确认：r.needsConfirmation === true
4. 仅显示冲突：r.hasConflict === true
```

#### 5.3.2 默认勾选规则（防误操作）

```typescript
默认勾选条件（必须同时满足）：
1. objectSuggestion.confidence >= 0.8  （高置信度）
2. hasConflict === false                （无冲突）
3. needsConfirmation === true            （需要确认）

不默认勾选：
- 置信度 < 0.8 的项
- 存在冲突的项
- 状态/行为升级建议（即使满足上述条件）
```

#### 5.3.3 批量操作规则

**批量接受**：
```typescript
前置条件：
1. selectedItems.size > 0
2. 用户确认操作（弹出确认对话框）

执行逻辑：
1. 遍历 selectedItems 中的每一项
2. 更新 objectSuggestion.status = 'accepted'
3. 更新 needsConfirmation = false
4. 生成 auditTrail：
   - basis: 'batch'
   - 记录批量操作的元信息
5. 清空 selectedItems
6. 显示操作结果提示
```

**批量拒绝**：
```typescript
执行逻辑同批量接受，但：
- status = 'rejected'
- 保留 needsConfirmation = true（拒绝后仍需关注）
```

**导出功能**：
```typescript
导出内容：
- 所有已确认的识别结果
- 包含确认信息和回溯信息
- 格式：JSON / Excel（根据需求）
```

---

### 5.4 冲突解释页逻辑

#### 5.4.1 冲突识别规则

```typescript
冲突定义：
- fieldSuggestions[].conflict === true
- 规则判断与 AI 判断不一致：
  ruleJudgment.ruleResult !== field.semanticRole
```

#### 5.4.2 推荐算法

```typescript
推荐逻辑：
function getRecommendedDecision(conflict) {
  const aiConfidence = conflict.confidence || 0;
  const ruleConfidence = conflict.ruleJudgment?.ruleConfidence || 0;
  
  // 如果 AI 置信度高于规则置信度 5% 以上，推荐 AI
  if (aiConfidence > ruleConfidence + 0.05) {
    return 'ai';
  }
  // 否则推荐规则
  return 'rule';
}

阈值说明：
- 差异阈值：5%（0.05）
- 目的：避免微小差异导致的频繁切换
```

#### 5.4.3 规则判断数据

```typescript
规则判断结构：
{
  rules: Array<{
    id: string;              // 规则编号，如 'R001'
    name: string;            // 规则名称
    reason: string;          // 命中原因
    weight: number;          // 权重 [0-1]
    result: string;          // 规则判断结果
  }>;
  ruleResult: string;        // 规则综合判断结果
  ruleConfidence: number;    // 规则综合置信度
}
```

#### 5.4.4 决策流程

```typescript
步骤1：选择方案
  - 采用规则：使用 ruleJudgment.ruleResult
  - 采用 AI：使用 field.semanticRole
  - 手动指定：用户输入自定义语义角色

步骤2：验证输入
  - 如果手动指定，必须填写语义角色
  - 决策说明为可选

步骤3：确认决策
  - 确定最终语义角色
  - 更新字段数据：
    * semanticRole = 最终确定的角色
    * status = 'accepted'
    * conflict = false
  - 生成 auditTrail：
    * 记录原始 AI 判断
    * 记录原始规则判断
    * 记录最终决策和依据
  - 更新表的 hasConflict 状态

步骤4：自动跳转
  - 如果有下一个冲突，自动切换
  - 如果无更多冲突，返回列表
```

#### 5.4.5 决策历史记录

```typescript
决策历史结构：
{
  [conflictKey]: {
    decision: 'rule' | 'ai' | 'manual';
    manualRole?: string;      // 手动指定时的角色
    note?: string;            // 决策说明
    timestamp: string;        // 决策时间
    finalRole: string;        // 最终确定的语义角色
  }
}

用途：
- 显示已决策的冲突项
- 支持查看历史决策
- 防止重复决策
```

---

## 六、业务规则与约束

### 6.1 状态流转规则

```
识别结果状态流转：
pending (待确认)
  ├─ accept → accepted (已接受)
  └─ reject → rejected (已拒绝)

字段状态流转：
pending / warning
  ├─ accept → accepted
  └─ reject → rejected

冲突状态流转：
conflict: true
  └─ 决策确认后 → conflict: false
```

### 6.2 置信度阈值规则

```typescript
置信度等级定义：
- 高置信度：>= 0.8 (80%)
- 中置信度：0.6 - 0.8 (60% - 80%)
- 低置信度：< 0.6 (60%)

应用场景：
1. 批量确认：仅高置信度 + 无冲突项默认勾选
2. 推荐算法：差异阈值 5% (0.05)
3. 风险提示：置信度 < 0.7 时显示风险
```

### 6.3 可回溯规则

```typescript
必须记录的信息：
1. 记录人（recordBy）
   - 来源：当前登录用户
   - 格式：用户名或用户ID

2. 记录时间（recordTime）
   - 格式：'YYYY-MM-DD HH:mm:ss'
   - 时区：系统时区

3. 依据（basis）
   - 'rule': 基于规则判断
   - 'ai': 基于 AI 判断
   - 'manual': 手动指定
   - 'batch': 批量操作

4. 决策信息（仅冲突解释页）
   - originalAI: 原始 AI 判断
   - originalRule: 原始规则判断
   - decision: 选择的方案
   - note: 决策说明（可选）
```

### 6.4 防误操作规则

```typescript
1. 批量确认：
   - 仅高置信度 + 无冲突项默认勾选
   - 批量操作前必须确认（弹出对话框）
   - 操作后显示结果统计

2. 冲突解决：
   - 手动指定时必须填写语义角色
   - 确认前验证输入完整性
   - 决策后自动保存，不可撤销（实际应用中可考虑撤销功能）

3. 状态/行为升级：
   - 升级建议不参与批量确认
   - 需要单独确认
```

---

## 七、数据验证规则

### 7.1 输入验证

```typescript
识别结果数据验证：
1. 必填字段检查：
   - id, tableName, sourceId 必须存在
   - objectSuggestion 必须存在
   - fieldSuggestions 必须为数组

2. 数据格式验证：
   - confidence: [0, 1] 区间
   - status: 枚举值验证
   - sourceId: 必须在 dataSources 中存在

3. 业务逻辑验证：
   - 如果 hasConflict === true，必须存在 conflict === true 的字段
   - 如果 needsConfirmation === false，所有字段 status 不应为 'pending'
```

### 7.2 操作验证

```typescript
确认操作验证：
1. 表级确认：
   - 对象名称不能为空
   - 置信度必须在有效范围内

2. 字段级确认：
   - 字段名必须存在
   - 语义角色不能为空

3. 冲突决策：
   - 必须选择方案
   - 手动指定时，语义角色不能为空
   - 语义角色长度限制（如 1-50 字符）
```

---

## 八、性能与优化规则

### 8.1 数据加载

```typescript
1. 懒加载：识别结果数据按需加载
2. 分页：如果数据量大，支持分页展示
3. 缓存：已确认的结果缓存，减少重复计算
```

### 8.2 渲染优化

```typescript
1. 虚拟滚动：列表项超过 100 条时使用虚拟滚动
2. 防抖：筛选和排序操作使用防抖
3. 记忆化：使用 useMemo 缓存计算结果
```

---

## 九、输出数据示例

### 9.1 确认后的表级识别结果

```json
{
  "id": "IR_001",
  "tableName": "order_info",
  "tableComment": "订单表",
  "sourceId": "DS_001",
  "objectSuggestion": {
    "name": "订单",
    "confidence": 0.92,
    "risk": "low",
    "status": "accepted",
    "source": "AI + 规则",
    "auditTrail": {
      "recordBy": "张三",
      "recordTime": "2024-05-21 14:30:25",
      "action": "accept",
      "basis": "ai"
    }
  },
  "fieldSuggestions": [
    {
      "field": "order_id",
      "semanticRole": "标识",
      "aiExplanation": "主键",
      "confidence": 0.95,
      "status": "accepted",
      "auditTrail": {
        "recordBy": "张三",
        "recordTime": "2024-05-21 14:30:25",
        "action": "accept",
        "basis": "ai"
      }
    },
    {
      "field": "pay_time",
      "semanticRole": "支付行为",
      "aiExplanation": "支付发生",
      "confidence": 0.75,
      "status": "accepted",
      "conflict": false,
      "auditTrail": {
        "recordBy": "张三",
        "recordTime": "2024-05-21 14:35:10",
        "action": "accept",
        "basis": "manual",
        "originalAI": "行为线索",
        "originalRule": "支付时间属性",
        "decision": "manual",
        "note": "结合业务场景，判断为支付行为更合适"
      }
    }
  ],
  "needsConfirmation": false,
  "hasConflict": false
}
```

---

## 十、关键业务场景

### 场景1：高置信度批量确认

```
输入：10 张表，置信度均 > 0.8，无冲突
流程：
1. 进入批量确认页
2. 系统自动勾选所有符合条件的表
3. 用户点击"批量接受"
4. 确认对话框显示："确定要接受 10 项识别结果吗？"
5. 用户确认
6. 所有表状态更新为 accepted
7. 生成批量操作的 auditTrail
输出：10 张表均已确认，可进入下一环节
```

### 场景2：冲突解决流程

```
输入：pay_time 字段，规则判断"支付时间属性"，AI 判断"行为线索"
流程：
1. 在识别结果对比页点击冲突字段的"查看冲突"按钮
2. 跳转到冲突解释页
3. 查看规则判断详情（命中规则、权重、综合判断）
4. 查看 AI 判断详情（推理依据、详细分析）
5. 系统推荐：AI（置信度 75% vs 规则 70%）
6. 用户选择：手动指定 → 输入"支付行为"
7. 填写决策说明："结合业务场景，判断为支付行为更合适"
8. 点击"确认决策"
9. 字段更新：semanticRole = "支付行为"，conflict = false
10. 生成完整的 auditTrail
输出：冲突已解决，字段语义角色确定为"支付行为"
```

### 场景3：低置信度人工审核

```
输入：置信度 0.65 的表对象建议
流程：
1. 在识别结果对比页查看该表
2. 查看 AI 解释（点击"为什么"）
3. 查看字段语义分类详情
4. 用户判断是否符合业务认知
5. 如果符合：点击"接受"
6. 如果不符合：点击"编辑"或"拒绝"
输出：根据用户判断更新状态和 auditTrail
```

---

## 十一、异常处理规则

### 11.1 数据异常

```typescript
1. 缺失数据：
   - 如果 objectSuggestion 缺失：显示"数据异常，请联系管理员"
   - 如果 fieldSuggestions 为空：显示"暂无字段识别结果"

2. 格式异常：
   - confidence 不在 [0,1]：默认设置为 0.5，并标记警告
   - status 不在枚举值：默认设置为 'pending'

3. 关联异常：
   - sourceId 不存在于 dataSources：显示"未知数据源"
```

### 11.2 操作异常

```typescript
1. 网络异常：
   - 操作失败时显示错误提示
   - 保留本地状态，支持重试

2. 并发冲突：
   - 如果数据已被其他用户修改：提示刷新
   - 使用乐观锁机制（版本号）

3. 权限异常：
   - 无确认权限：禁用操作按钮，显示提示
```

---

## 十二、术语映射（业务语言）

```typescript
内部术语 → 业务语言：
- Entity → "对象"
- Event → "业务行为"
- Snapshot → "业务结果"
- Rule Score → "规则置信度"（隐藏，仅显示置信度）
- AI Score → "AI 置信度"（隐藏，仅显示置信度）
- Semantic Role → "语义角色" / "字段含义"
- Conflict → "规则与 AI 判断不一致"
```

---

## 总结

**识别结果确认**模块的核心价值：

1. **验证准确性**：通过人工确认，确保识别结果符合业务认知
2. **提升效率**：批量处理高置信度结果，减少重复操作
3. **建立信任**：透明化规则和 AI 判断过程，建立用户信任
4. **解决冲突**：提供冲突解释和决策机制，确保结果一致性
5. **可追溯性**：完整记录确认过程，支持审计和回溯

**关键输入**：AI + 规则引擎的识别结果  
**关键输出**：经过业务人员确认的、可信任的语义识别结果  
**关键规则**：置信度阈值、冲突解决算法、可回溯记录、防误操作

